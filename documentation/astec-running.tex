
From version 2.0, the data architecture should be as follows
\dirtree{%
.1 <EMBRYO>.
.2 RAWDATA.
.3 LC.
.4 Stack0000.
.4 Stack0001.
.3 RC.
.4 Stack0000.
.4 Stack0001.
.2 FUSE.
.3 FUSE\_<EXP\_1>.
.3 FUSE\_<EXP\_2>.
.3 \ldots .
.3 FUSE\_RELEASE.
.2 SEG.
.3 SEG\_<EXP>.
.3 \ldots .
.3 SEG\_RELEASE.
.2 POST.
.3 POST\_<EXP>.
.3 \ldots .
.3 POST\_RELEASE.
}


\texttt{<SOMETHING>\_RELEASE} sub-directories should content the "last version" validated by an expert. \texttt{<SOMETHING>\_<EXP\_x>} are folders containing the different experiments conducted at one given step (with different parameters/methods). After inspection of the results, one of them is supposed to be renamed as  \texttt{<SOMETHING>\_RELEASE} and the others can be deleted.


Particular files:
\begin{itemize}
\item[] \texttt{nomenclature.py}: file fixing the set of naming rules in working directories
\begin{itemize}
\item  this file should not be modified.
\end{itemize}
\item[] \texttt{parameters.py}: file defining the set of parameters useful for all the process steps (parameters are all prefixed with respect to the step they are used in).
\begin{itemize}
\item  it is a "template" file which should be duplicated and whose copy can be modified by the user to its convenience (only the parameter values should be modified, not their name...).
\end{itemize}
\end{itemize}



The scripts of steps \texttt{1-fuse.py}, \texttt{2-mars.py}, \texttt{3-manualcorrection.py}, \texttt{4-astec.py}, \texttt{5-postcorrection.py} are executables, so that each astec step calling can be made as described here:
For example, in order to launch the fusion step on an embryo called \texttt{"171107-Karine-St8"} one should:
\begin{enumerate}
\item Duplicate the file \texttt{<astec-package>/parameters.py} and rename it as a new file \texttt{<arbitrary-path>/parameters\_karine.py}
\item Edit this new  file \texttt{<arbitrary-path>/parameters\_karine.py}to specify the desired value of each parameter related to the fusion step
\item In a terminal,
\begin{code}{0.8}
\$ cd <astec-package> \# in order to be in the astec directory (/media/DATA/Codes/astec-package on Hermione) \\
\$./1-fuse.py --parameters  <arbitrary-path>/parameters\_karine.py --embryo-rep /media/DATA/171107-Karine-St8/
\end{code}
 (or equivalently,a shorter format)
 \begin{code}{0.8}
\$./1-fuse.py -p  <arbitrary-path>/parameters\_karine.py -e /media/DATA/171107-Karine-St8/
\end{code}
\end{enumerate}


At each Astec step execution, a copy of the parameters file as well as a log file are automatically generated in the target working directory.

For each Astec step, it is possible to display the help relative to the corresponding script by launching the script with the option \option{--help}. For example, for the fusion step:

    In a terminal, launch the command line:
\begin{code}{0.8}
\$ <astec-package>/1-fuse.py --help
\end{code}
    The terminal displays the following message:
    
\begin{code}{0.8}
    Usage: 1-fuse.py [options] \\
    Options:\\
      -h, --help            show this help message and exit\\
      -p FILE, --parameters=FILE\\
                                python file containing parameters definition\\
      -e PATH, --embryo-rep=PATH\\
                                path to the embryo data\\
      -q, --quiet          don't print status messages to stdout\\
\end{code}



\section{The \texttt{parameters-example.py} file}
\label{sec:parameters:original}

\begin{attention}
The file included below  may be not up-to-date with respect to the software package. Please refer to the file \texttt{parameters-example.py} of the ASTEC distribution.
\end{attention}

\begin{verbatim}
     1	
     2	
     3	# File for parameters and nomenclature settings
     4	
     5	PATH_EMBRYO=''	
     6	                # Must be the path to the embryo data 
     7					# eg: '/media/DATA/171107-Karine-St8'
     8					# Can also be set by providing option '-e' in the command line
     9	EN=''			
    10	                # Embryo Name 
    11	                # CRBM naming format is YYMMDD-SaintOfTheDays-Stage
    12					# eg: '171107-Karine-St8'
    13					# (automatically extracted from PATH_EMBRYO if not provided)
    14	
    15	
    16	EXP_FUSE=''	
    17	            # Workspace for the considered step; this workspace
    18				# is included in the repository corresponding to the
    19				# ASTEC step ([FUSE|SEG|POST]) and prefixed by this
    20				# repository name (eg. FUSE_EXP_NO_CROP or SEG_RELEASE)
    21				# ----> use replaceDIR_EXP_FUSE(path_fuse_exp[...], EXP_FUSE) 
    22				# method from <astec-package>/nomenclature.py to get the right
    23				# path for the given fusion experience
    24	EXP_REG=''	
    25	            #
    26	EXP_MARS=''	
    27	            #
    28	EXP_SEG=''	
    29	            #
    30	EXP_POST=''	
    31	            #
    32	
    33	
    34	#TIME=''		# Time-point of an embryo snapshot 
    35	#TIMEREF=''		# For registration, time-point of reference snapshot
    36	#TIMEFLO=''		# For registration, time-point of floating snapshot
    37	
    38	##########################
    39	### GENERAL PARAMETERS ###
    40	##########################
    41	
    42	begin=1 				 
    43	                         # First time point
    44	end=5   				 
    45	                         # Last time point
    46	delta=1     			 
    47	                         # Delta between two time points (if one does not want
    48							 # to deal with every single time point) (default = 1)
    49	target_resolution = .3   
    50	                         # Isotropic resolution of the final fused and 
    51							 # segmented images (default = 0.3)
    52	
    53	
    54	##########################
    55	### RAWDATA DEFINITION ###
    56	##########################
    57	
    58	raw_ori = 'left' 				
    59	                                # if im2 angle - im1 angle < 0 => right
    60	raw_resolution = (.17, .17, 1.) 
    61	                                # Resolution of the raw images (here are the 
    62									# known values for 140317-Patrick-St8)
    63	#raw_resolution = (.21, .21, 1.) 
    64	                                # Resolution of the raw images for Karine
    65	raw_delay = 0 					
    66	                                # If the time stamps in the folder are not the
    67									# actual time stamps in the global movie
    68	raw_mirrors = False  			
    69	                                # Depends on the acquisition protocol, value 
    70									# can be set to True or False
    71									#  - the standard value of this parameter is 
    72									#    False
    73									#  - in case of axial symmetry between left 
    74									#    and right cameras, then set to True
    75	
    76	
    77	
    78	
    79	#########################
    80	### FUSION PARAMETERS ###
    81	#########################
    82	
    83	fusion_margin_x_0 = 40 
    84	                       # margin_x_0 [default=40]: parameter for margin of the
    85						   # bounding box computed for the cropping of the 
    86						   # resampled image in 'left' x direction 
    87	fusion_margin_x_1 = 40 
    88	                       # margin_x_1 [default=40]: parameter for margin of the
    89					       # bounding box computed for the cropping of the 
    90					       # resampled image in 'right' x direction
    91	fusion_margin_y_0 = 40 
    92	                       # margin_y_0 [default=40]: parameter for margin of the
    93						   # bounding box computed for the cropping of the 
    94						   # resampled image in 'top' y direction
    95	fusion_margin_y_1 = 40 
    96	                       # margin_y_1 [default=40]: parameter for margin of the
    97						   # bounding box computed for the cropping of the 
    98						   # resampled image in 'bottom' y direction
    99	fusion_crop = True     
   100	                       # crop [default=True]: 
   101	                       # if False, then the resampled image is not cropped ; 
   102						   # if True, then image is cropped
   103	
   104	
   105	
   106	
   107	#######################
   108	### MARS PARAMETERS ###
   109	#######################
   110	
   111	# Modules choice
   112	mars_method=1 			
   113	                        # 1 for 'Classic' method
   114				  			# 2 for 'Gace' method
   115	# General parameters for MARS segmentation
   116	mars_sigma1 = 0.6  		
   117	                        # sigma 1 (0.6um) in real coordinates
   118	mars_sigma2 = 0.15 		
   119	                        # sigma 2 (0.15um) in real coordinates
   120	mars_h_min = 4     		
   121	                        # H min initialisation to ease correction
   122	# Gace Parameters (if mars_method is set to 2):
   123	# membrane_renforcement
   124	mars_sigma_membrane=0.9 
   125	                        # membrane enhancement parameter (in real units, a 
   126							# priori 0.9 um is a good choice for data like 
   127							# Patrick/Ralph/Aquila)
   128	# anisotropicHist /!\ critical step
   129	mars_sensitivity=0.99   
   130	                        # membrane binarization parameter, /!\ if failure,
   131							# one should enter in "manual" mode of the function
   132							# anisotropicHist via activation of 'manual' option
   133	
   134	mars_manual=False     	
   135	                        # By default, this parameter is set to False. If 
   136							# failure, (meaning that thresholds are very bad, 
   137							# meaning that the binarized image is very bad),
   138					 		# set this parameter to True and relaunch the 
   139					 		# computation on the test image. If the method fails
   140					 		# again, "play" with the value of manual_sigma... 
   141					 		# and good luck.
   142	mars_manual_sigma=15    
   143	                        # Axial histograms fitting initialization parameter 
   144							# for the computation of membrane image binarization
   145							# axial thresholds (this parameter is used iif 
   146							# manual = True).
   147							# One may need to test different values of 
   148							# manual_sigma. We suggest to test values between 5 and
   149							# 25 in case of initial failure. Good luck.
   150	
   151	mars_hard_thresholding=False  
   152	                              # If the previous membrane threshold method 
   153								  # failed, one can force the thresholding with a
   154								  # "hard" threshold applied on the whole image. 
   155								  # To do so, this option must be set to True.
   156	mars_hard_threshold=1.0       
   157	                              # If hard_thresholding = True, the enhanced 
   158								  # membranes image is thresholded using this 
   159								  # parameter (value 1 seems to be ok for 
   160								  # time-point t001 of Aquila embryo for example).
   161	
   162	# Tensor voting framework
   163	mars_sigma_TV=3.6     
   164	                      # parameter which defines the voting scale for membrane
   165						  # structures propagation by tensor voting method (real
   166						  # coordinates). 
   167					 	  # This parameter shoud be set between 3 um (little cells)
   168					 	  # and 4.5 um(big gaps in the binarized membrane image)
   169	mars_sigma_LF=0.9     
   170	                      # Smoothing parameter for reconstructed image (in real
   171						  # coordinates). It seems that the default value = 0.9 um
   172						  # is ok for classic use.
   173	mars_sample=0.2       
   174	                      # Parameter for tensor voting computation speed 
   175						  # optimisation (do not touch if not bewared)
   176	
   177	
   178	
   179	####################################
   180	### MANUAL CORRECTION PARAMETERS ###
   181	####################################
   182	
   183	mancor_seg_file='' 	   
   184	                       # segmentation file to be manually corrected
   185						   # If not provided, then looking for the output of MARS
   186	mancor_mapping_file='' 
   187	                       # path to mapping file for manual correction of the 
   188						   # mars segmentation. See above the syntax of this file.
   189						   # - 1 line per label association
   190						   # - background label has value 1
   191						   # - the character '#' denotes commented lines 
   192						   # See file "mapping.txt" in the astec project to get an
   193						   # example
   194	'''
   195	# EXAMPLE OF mancor_mapping_file CONTENT:
   196	# here the input label 8 will be mapped with new value 7, etc...
   197	8 7
   198	9 2  
   199	4 64 
   200	29 23
   201	# ... etc ...
   202	# background labels
   203	30 1 
   204	89 1 
   205	'''
   206	
   207	
   208	
   209	###########################################
   210	### SEGMENTATION PROPAGATION PARAMETERS ###
   211	###########################################
   212	
   213	
   214	# Modules choice
   215	
   216	astec_membrane_reconstruction_method=0
   217	# Membrane reconstruction module choice
   218	# 0 for 'Classic' method
   219	# 1 for 'Glace' method
   220	# 2 for 'Gace' method
   221	# If not set or set to 0, the input fused image is not processed for 
   222	# membrane structures enhancement.
   223	# If set to 1, the GLACE reconstruction method is going to be called
   224	# If set to 2, the GACE reconstruction method is going to be called
   225	
   226	astec_fusion_u8_method=0
   227	# Selection of the method which converts the fused image into a 8 bits
   228	# images for the segmentation propagation. 
   229	# If set to 0 (default), calling the historical "to_u8" method
   230	# If set to 1, calling the mc-adhocFuse program which enhances the fused 
   231	# image while converting it to u8 knowing the semgnetation propagation from
   232	# previous time point
   233	
   234	astec_flag_hybridation=False
   235	# If set to True and if the membrane_reconstruction_method parameter is 
   236	# provided and not equal to 0, then the reconstructed gray level image
   237	# used for the segmentation propagation framework is goind to be an hybridation 
   238	# between the original fused image and the result of image reconstruction by
   239	# the specified method.
   240	
   241	astec_keep_reconstruct_files=False 
   242	# Set it to True in order to keep a copy
   243	# Flag enabling to keep a copy of graylevel files provided to the watershed
   244	
   245	
   246	
   247	# General parameters for segmentation propagation
   248	astec_sigma1 = 0.6  		
   249	                            # sigma 1 (0.6um) in real coordinates
   250	astec_sigma2 = 0.15 		
   251	                            # sigma 2 (0.15um) in real coordinates
   252	astec_h_min_min = 2    		
   253	                            # H min initialisation to ease correction
   254	astec_h_min_max = 18   		
   255	                            # H min initialisation to ease correction
   256	
   257	# Glace Parameters (if astec_membrane_reconstruction_method is set to 1 or 2):
   258	# membrane_renforcement
   259	astec_sigma_membrane=0.9
   260	                        # membrane enhancement parameter (in real units, a
   261							# priori 0.9 um is a good choice for data like 
   262							# Patrick/Ralph/Aquila)
   263	# anisotropicHist /!\ critical step
   264	astec_sensitivity=0.99  
   265	                        # membrane binarization parameter, /!\ if failure,
   266							# one should enter in "manual" mode of the function
   267							# anisotropicHist via activation of 'manual' option
   268	
   269	astec_manual=False     	
   270	                        # By default, this parameter is set to False. If 
   271							# failure, (meaning that thresholds are very bad, 
   272							# meaning that the binarized image is very bad),
   273					 		# set this parameter to True and relaunch the 
   274					 		# computation on the test image. If the method fails
   275					 		# again, "play" with the value of manual_sigma... 
   276					 		# and good luck.
   277	astec_manual_sigma=15   
   278	                        # Axial histograms fitting initialization parameter 
   279							# for the computation of membrane image binarization
   280							# axial thresholds (this parameter is used iif 
   281							# manual = True).
   282							# One may need to test different values of 
   283							# manual_sigma. We suggest to test values between 5 and
   284							# 25 in case of initial failure. Good luck.
   285	
   286	astec_hard_thresholding=False 
   287	                              # If the previous membrane threshold method 
   288								  # failed, one can force the thresholding with a
   289								  # "hard" threshold applied on the whole image. 
   290								  # To do so, this option must be set to True.
   291	astec_hard_threshold=1.0      
   292	                              # If hard_thresholding = True, the enhanced 
   293								  # membranes image is thresholded using this 
   294								  # parameter (value 1 seems to be ok for 
   295								  # time-point t001 of Aquila embryo for example).
   296	
   297	# Tensor voting framework
   298	astec_sigma_TV=3.6    
   299	                      # parameter which defines the voting scale for membrane
   300						  # structures propagation by tensor voting method (real
   301						  # coordinates). 
   302					 	  # This parameter shoud be set between 3 um (little cells)
   303					 	  # and 4.5 um(big gaps in the binarized membrane image)
   304	astec_sigma_LF=0.9    
   305	                      # Smoothing parameter for reconstructed image (in real
   306						  # coordinates). It seems that the default value = 0.9 um
   307						  # is ok for classic use.
   308	astec_sample=0.2      
   309	                      # Parameter for tensor voting computation speed 
   310						  # optimisation (do not touch if not bewared)
   311	astec_rayon_dil=3.6   
   312	                      # dilatation ray for propagated ROI from time t to t+1
   313						  # (default: 3.6, in real coordinates) 
   314	
   315	# Fused image conversion parameters (if astec_fusion_u8_method is set to 1)
   316	astec_min_percentile=0.01   
   317	                      # mc-adhocFuse parameter of type %f (default: 0.01)
   318	astec_max_percentile=0.99   
   319	                      # mc-adhocFuse parameter of type %f (default: 0.99)
   320	astec_min_method='cellinterior'
   321	                      # mc-adhocFuse param. (default: 'cellinterior')
   322					      # taken in global|cell|cellborder|cellinterior|voxel
   323	astec_max_method='cellborder'
   324	                      # mc-adhocFuse parameter (default: 'cellborder')
   325						  # taken in global|cell|cellborder|cellinterior|voxel
   326	astec_sigma_hybridation=5.0 
   327	                      # mc-adhocFuse parameter of type %f (default: 5.0)
   328	
   329	# Default parameters (for classical use, default values should not be changed)
   330	astec_RadiusOpening=20 		
   331	                      # (using the approximation of a sphere of radius 20
   332						  # voxels as a structuring element)
   333	astec_Thau= 25 				
   334	                      # s(c)=h2+(c).N2(c) >t identical
   335	astec_MinVolume=1000 		
   336	                      # Miss Suppressing cells with to small volumes (not
   337						  # yet in supdata)
   338	astec_VolumeRatioBigger=0.5 
   339	                      # If a cell in St+1 is at least 50% bigger than its
   340						  # progeny in St+1, 
   341	astec_VolumeRatioSmaller=0.1
   342	                      # Cells in St+1 that are 10% or smaller than their
   343						  # equivalent in St+1 are tagged for correction
   344	astec_MorphosnakeIterations=10 
   345	                      # Then, an active contour algorithm is applied
   346					      # using the dilated shape of c, obtained by 
   347						  # iterating 10 times
   348	astec_NIterations=200 		
   349	                      # The algorithm is applied up to stability 
   350						  # (at th voxels) or after n iterations 
   351						  # (in our case th = 103 and n = 200). 
   352	astec_DeltaVoxels=10**3  	
   353	                      # y (at th voxels)
   354	astec_Volum_Min_No_Seed=100 
   355	                      # Then, if the volume of c is greater than 100 
   356						  # voxels (2.7 um3)
   357	astec_nb_proc=10 			
   358	                      # Number of processor ...
   359	astec_nb_proc_ace=7   		
   360	                      # number of processors for ACE (7 is recommanded)
   361	
   362	
   363	
   364	##################################
   365	### POST-CORRECTION PARAMETERS ###
   366	##################################
   367	
   368	postcor_Volume_Threshold=10000 	
   369	                      # volume low threshold for final cells 
   370						  # (in voxels) 
   371	postcor_Soon=True 				
   372	                      # True if the cell life span has to be 
   373						  # taken into account
   374	postcor_ShortLifespan=25 		
   375	                      # (length < SL time points, in our case 
   376						  # SL = 10)
   377	postcor_PearsonThreshold=0.9; 	
   378	                      # If they are anticorrelated (Pearson 
   379						  # correlation under -0.9)
   380	
   381	
   382	
\end{verbatim}


\section{List of command line interfaces}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% 1-fuse.py
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{\texttt{1-fuse.py}}
\label{sec:cli:fuse}

The fusion is made of the following steps.

\begin{enumerate}
\item Optionally, a slit line correction. Some Y lines may appear brighter in the acquisition and causes artifacts in the reconstructed (i.e. fused) image. By default, it is not done.

\item a change of resolution in the X and Y directions only (Z remains unchanged). It allows to decrease the data volume (and then the computational cost) if the new pixel size (set by \verb|target_resolution|) is larger than the acquisition one.

\item \label{it:fusion:crop:1} Optionally, a crop of the resampled acquisitions. It allows to decrease the volume of data, hence the computational cost. The crop is based on the analysis of a MIP view (in the Z direction) of  the volume, and thus is sensitive to hyper-intensities if any. By default, it is done.

\item Optionally, a mirroring of the 'right' image. It depends on the value of  \verb|raw_mirrors| variable.

\item \label{it:fusion:registration} Linear registration of the 3 last images on the first one (considered as the reference). The reference image is resampled again, to get an isotropic voxel (whose size is given by \verb|target_resolution|), i.e. the voxel size is the same along the 3 directions: X, Y, Z.

\item Linear combination of images, weighted by an ad-hoc function.

\item Optionally, a crop of the fused image, still based on the analysis of a MIP view (in the Z direction). By default, it is done.
\end{enumerate}
Please refer to the file \texttt{parameters-example.py} which describes all useful variables to control these steps.



\subsubsection{Basic use}
\label{sec:cli:fuse:basic:use}
Assume that the raw data are organized as follows
\dirtree{%
.1 180927-Vincent-Nodal-St8.
.2 RAWDATA.
.3 LC.
.4 Stack0000.
.5 Cam\_Left\_00000.zip.
.5 Cam\_Left\_00001.zip.
.5  \ldots .
.4 Stack0001.
.5 Cam\_Left\_00000.zip.
.5 Cam\_Left\_00001.zip.
.5 \ldots .
.3 RC.
.4 Stack0000.
.5 Cam\_Right\_00000.zip.
.5 Cam\_Right\_00001.zip.
.5 \ldots .
.4 Stack0001.
.5 Cam\_Right\_00000.zip.
.5 Cam\_Right\_00001.zip.
.5 \ldots .
}

Then a simple parameter file (see \texttt{astec-parameters-examples/parameters-fusion-vincent-1.py}) allows to perform the fusion
\begin{verbatim}
# path to the embryo data

PATH_EMBRYO = '/Users/greg/COLLABORATIONS/DIGEM/DATA/TEST/180927-Vincent-Nodal-St8'

# Embryo Name

EN = '180927-Vincent-Nodal-St8'

# time points to be processed
# begin: first time point
# end: last time point
# delta: Delta between two time points (if one does not want
#        to deal with every single time point) (default = 1)

begin = 0
end = 0
delta = 1

# output image format
#
# default_image_suffix is for all images (including auxiliary ones)

default_image_suffix = 'mha'

# raw_ori: image orientation, value is in {'right','left'}
#   if im2 angle - im1 angle < 0 => raw_ori = 'right'
# raw_mirrors: value is in {True, False}
# 	- the standard value of this parameter is False
# 	- in case of axial symmetry between left
# 	  and right cameras, then set to True
# raw_resolution: acquisition voxel size
# raw_delay: increment to to be added to the time values
#   (values in range [begin,end]) when generating the
#   fused image names (default is 0)

raw_ori = 'left'
raw_mirrors = False
raw_resolution = (.195, .195, 1.)
raw_delay = 0

# Isotropic resolution of the final fused image

target_resolution = .3
\end{verbatim}

\subsubsection{Other organization of data}

In case of the data organization does not follow the one described in section \ref{sec:cli:fuse:basic:use}, the variables
\verb|DIR_RAWDATA|, \verb|DIR_LEFTCAM_STACKZERO|,  \verb|DIR_RIGHTCAM_STACKZERO|, \verb|DIR_LEFTCAM_STACKONE|, and \verb| DIR_RIGHTCAM_STACKONE| allow a finer control of the directory names, while the variables
\verb|acquisition_leftcam_image_prefix| and 
\verb|acquisition_rightcam_image_prefix| allow a finer control of the file names.

For instance, assume that the data ar organized as below:
\dirtree{%
.1 180927-Vincent-Nodal-St8.
.2 RAWDATA.
.3 stack\_0\_channel\_0.
.4 Cam\_Left\_00000.zip.
.4 Cam\_Left\_00001.zip.
.4  \ldots .
.4 Cam\_Right\_00000.zip.
.4 Cam\_Right\_00001.zip.
.4 \ldots .
.3 stack\_1\_channel\_0.
.4 Cam\_Left\_00000.zip.
.4 Cam\_Left\_00001.zip.
.4  \ldots .
.4 Cam\_Right\_00000.zip.
.4 Cam\_Right\_00001.zip.
.4 \ldots .
}

Then, fusion can be achieved by adding the following lines to the parameter file of section \ref{sec:cli:fuse:basic:use}  (see \texttt{astec-parameters-examples/parameters-fusion-vincent-2.py}).

\begin{verbatim}
DIR_LEFTCAM_STACKZERO = 'stack_0_channel_0'
DIR_RIGHTCAM_STACKZERO = 'stack_0_channel_0'
DIR_LEFTCAM_STACKONE = 'stack_1_channel_0'
DIR_RIGHTCAM_STACKONE = 'stack_1_channel_0'
\end{verbatim}

\subsubsection{Linear registration}

To decrease the computational cost, images are normalized and cast on one byte before registration. While it generally does not degrade the registration quality, it may induce troubles when hyper-intensities areas are present in the image. In such a case, the useful information may then be summarized in only a few intensity values.

Intensity normalization in registration can be deactivated.
%  (see \texttt{astec-parameters-examples/parameters-fusion-vincent-3.py}) by
\begin{verbatim}
fusion_registration_normalization = False
\end{verbatim}

Hyper-intensities areas may also the threshold calculation used for the automatic crop (step \ref{it:fusion:crop:1} of fusion). In such cases, the iterative registration method may find a local minimum that is not the desired one, because the relative positions of the two images to be co-registered are too far apart. To circumvent such a behavior, a hierarchical registration can be done. It consists on a first pre-registration with a transformation with fewer degrees of freedom. 

Intensity normalization in registration can be deactivated by
\begin{verbatim}
fusion_preregistration_compute_registration = True
# fusion_preregistration_transformation_type = 'translation'
fusion_preregistration_normalization = False

# fusion_registration_compute_registration = True
# fusion_registration_transformation_type = 'affine'
fusion_registration_normalization = False
\end{verbatim}
It may be also preferable to  deactivate the image normalization for both registration steps.
% (see \texttt{astec-parameters-examples/parameters-fusion-vincent-4.py}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{\texttt{1.5-intraregistration-GC.py}}

\subsection{\texttt{1.5-intraregistration.py}}

The intra-registration procedure can be done either after the fusion step, or after the segmentation step. It aims at
\begin{itemize}
\item resampling the fusion and/or the segmentation images into a common frame/geometry, so they can better be compared, and
\item building 2D+t images made of 2D sections from either the  fusion and/or the segmentation images, so that the quality of the fusion and/of the tracking step can be visually assessed.
\end{itemize}
Its results will be stored in the \verb|INTRAREG/INTRAREG_<EXP>| subdirectory where \verb|<EXP>| is set by \verb|EXP_INTRAREG| from the parameter file. \verb|POST| and \verb|SEG| directories are created only if respectively segmentation and post-segmentation sequences are required to be resampled/reconstructed in the common frame.

\dirtree{%
.1 <EMBRYO>.
.2 \ldots.
.2 INTRAREG.
.3 INTRAREG\_<EXP>.
.4 CO-TRSFS.
.4 FUSE.
.4 LOGS.
.4 MOVIES.
.4 POST.
.4 SEG.
.4 TRSFS\_t<F>-<L>.
.2 \ldots.
}

The intra-registration procedure is made of the following steps:
\begin{enumerate}

\item Co-registration of pairs of successive fused images (section \ref{sec:cli:intraregistration:coregistration}). This yields the transformations $T_{t+1 \leftarrow t}$. Fused images are located in \verb|<EMBRYO>/FUSE/FUSE_<EXP_FUSE>|: the parameter \verb|EXP_FUSE| is either set in the parameter file or is set at \verb|RELEASE|. This step may be long.

\item Composition of transformations issued from the co-registration  step. This step computes the transformations $T_{ref \leftarrow t}$. towards a reference image \verb|ref| given by the parameter \verb|intra_registration_reference_index|.

\item Computation of the \textit{template} image (section \ref{sec:cli:intraregistration:template}). This \textit{template} image dimension are computed so that the useful information of all resampled images fits into it. Useful information can be issued from either the fused sequence, the segmentation sequence or the post-segmentation sequence. It is indicated by the \verb|intra_registration_template_type| which value can be either \verb|'FUSION'|,  \verb|'SEGMENTATION'|, or \verb|'POST-SEGMENTATION'|. This step may be long.

\item Resampling of either the fused or the segmentation images  (section \ref{sec:cli:intraregistration:resampling}). Note that changing the parameters for this step will not require to re-compute the first steps.

\item Extraction of 2D+t images from the resampled sequences (section \ref{sec:cli:intraregistration:movies}). Note that changing the parameters for this step (i.e. requiring extra movies) will not require to re-compute the first steps, with an eventual exception for the resampling step.

\end{enumerate}


\subsubsection{Co-registration parameters}
\label{sec:cli:intraregistration:coregistration}
Default registration parameters for the co-registration are set by:
\begin{verbatim}
# intra_registration_compute_registration = True
# intra_registration_transformation_type = 'rigid'
# intra_registration_transformation_estimation_type = 'wlts'
# intra_registration_lts_fraction = 0.55
# intra_registration_pyramid_highest_level = 6
# intra_registration_pyramid_lowest_level = 3
# intra_registration_normalization = True
\end{verbatim}
Computed transformations are stored in \verb|INTRAREG/INTRAREG_<EXP>/CO-TRSFS|.
It may be advised to set the pyramid lowest level value to some higher value to speed up the co-registrations (recall that all pairs of successive images will be co-registered, i.e.
\begin{verbatim}
intra_registration_pyramid_lowest_level = 4
\end{verbatim}


\subsubsection{Template building parameters}
\label{sec:cli:intraregistration:template}

\begin{verbatim}
# intra_registration_reference_index = None
# intra_registration_template_type = 'FUSION'
# intra_registration_template_threshold = None
# intra_registration_resolution = 0.6
# intra_registration_margin = None
\end{verbatim}

The \verb|intra_registration_reference_index| allows to choose the reference image (the one which remains still, i.e. is only displaced by a translation), by default it is the first image image of the series (associated to \verb|begin|).

Depending on \verb|intra_registration_template_type| (\verb|'FUSION'|, \verb|'SEGMENTATION'| or \verb|'POST-SEGMENTATION'|, the two latter assume obviously that the segmentation has been done), the \textit{template} image can be built either after the fusion or the segmentation images. If no threshold is given by \verb|intra_registration_template_threshold|, the built template will be large enough to include all the transformed fields of view (in this case, the template is the same whatever \verb|intra_registration_template_type| is). 

If a threshold is given, the built template will be large enough to include all the transformed points above the threshold. E.g., the background is labeled with either '1' or '0' in segmentation images, then a threshold of '2' ensures that all the embryo cells will not be cut by the resampling stage.  In this case, adding an additional margin to the template could be a good idea for visualization purpose. Last but not least, using a larger resolution than the \verb|intra_registration_resolution| allows to decrease the resampled images volume (the default resolution i.e. voxel size, given by  \verb|target_resolution|, for the fusion step (see section \ref{sec:cli:fuse:basic:use}), is set to 0.3, while it is set to 0.6 here).

Thus, building a \textit{template} image after the segmentation images can be done with
\begin{verbatim}
# intra_registration_reference_index = None
intra_registration_template_type = "SEGMENTATION"
intra_registration_template_threshold = 2
# intra_registration_resolution = 0.6
intra_registration_margin = 10
\end{verbatim}

Computed transformations from the \textit{template} image as well as the \textit{template} image itself are stored in \verb|INTRAREG/INTRAREG<EXP>/TRSFS_t<F>-<L>| where \verb|<F>| and \verb|L| are the first and the last index of the series (specified by \verb|begin| and \verb|end| from the parameter file).

\subsubsection{Resampling fusion/segmentation images}
\label{sec:cli:intraregistration:resampling}
The resampled fusion and segmentation images will be stored respectively in \verb|INTRAREG/INTRAREG_<EXP>/FUSE|, \verb|INTRAREG/INTRAREG_<EXP>/SEG| and \verb|INTRAREG/INTRAREG_<EXP>/POST|. Resampling is done either if the following parameters are set to \verb|True| or if movies are requested to be computed.

\begin{verbatim}
# intra_registration_resample_fusion_images = True
# intra_registration_resample_segmentation_images = False
# intra_registration_resample_post_segmentation_images = False
\end{verbatim}

\subsubsection{2D+t movies}
\label{sec:cli:intraregistration:movies}
For either visual assessment or illustration purposes, 2D+t (i.e. 3D) images can be built from 2D sections extracted from the resampled temporal series. This is controlled by the following parameters:
\begin{verbatim}
# intra_registration_movie_fusion_images = True
# intra_registration_movie_segmentation_images = False

# intra_registration_xy_movie_fusion_images = [];
# intra_registration_xz_movie_fusion_images = [];
# intra_registration_yz_movie_fusion_images = [];

# intra_registration_xy_movie_segmentation_images = [];
# intra_registration_xz_movie_segmentation_images = [];
# intra_registration_yz_movie_segmentation_images = [];

# intra_registration_xy_movie_post_segmentation_images = [];
# intra_registration_xz_movie_post_segmentation_images = [];
# intra_registration_yz_movie_post_segmentation_images = [];
\end{verbatim}

If \verb|intra_registration_movie_fusion_images| is set to \verb|True|, a movie is made with the  XY-section located at the middle of each resampled fusion image (recall that, after resampling, all images have the same geometry). Additional XY-movies can be done by specifying the wanted Z values in \verb|intra_registration_xy_movie_fusion_images|. E.g.
\begin{verbatim}
intra_registration_xy_movie_fusion_images = [100, 200];
\end{verbatim}
will build two movies with XY-sections located respectively at Z values of 100 and 200. The same stands for the other orientation and for the resampled segmentation images.


\subsection{\texttt{2-mars.py}}

\subsection{\texttt{3-manualcorrection.py}}

\subsection{\texttt{4-astec.py}}

\subsection{\texttt{5-postcorrection.py}}

\subsection{\texttt{6-named.py}}

\subsection{\texttt{7-virtualembryo.py}}




